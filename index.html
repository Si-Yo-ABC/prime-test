<!DOCTYPE html>
<html>
<head>
    <title>Dragon Engine Test</title>
    <style>
        body {
    background-color: #0d1117;
    color: #c9d1d9;
    font-family: 'Courier New', Courier, monospace;
    line-height: 1.6;
}

.container {
    max-width: 1100px;
    margin: auto;
    padding: 20px;
}

.panel {
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 6px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
}

h3 {
    color: #58a6ff;
    border-bottom: 1px solid #30363d;
    padding-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 2px;
}

input, select {
    background: #0d1117;
    border: 1px solid #30363d;
    color: #58a6ff;
    padding: 10px;
    border-radius: 4px;
    font-family: inherit;
}

/* The Navigation Buttons */
.btn-teleport { background: #238636; color: white; border: none; padding: 10px 20px; cursor: pointer; font-weight: bold; border-radius: 4px; }
.btn-ignite { background: #1f6feb; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; }
.btn-purge { background: #da3633; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.8em; }

/* The Bifurcation Alert */
#seed-panel {
    border: 1px solid #d29922;
    background: rgba(210, 153, 34, 0.1);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { border-color: #d29922; }
    50% { border-color: #f0883e; }
    100% { border-color: #d29922; }
}

.prime-card {
    border-left: 4px solid #58a6ff;
    background: #161b22;
    padding: 20px;
    border-radius: 0 6px 6px 0;
}

.value {
    font-size: 1.5em;
    color: #79c0ff;
    display: block;
    margin: 10px 0;
    word-wrap: break-word;
}
    </style>
</head>
<body>
<div class="container">
    <div class="panel">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>Dragon Control Unit: Command Tower</h3>
            <div>
                <button onclick="downloadVault()" class="btn-download">LOGS</button>
                <button onclick="purgeVault()" class="btn-purge">PURGE</button>
            </div>
        </div>

        <div class="lane-selector" style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333;">
            <p style="color:#00bcff; margin-top:0;">[NAVIGATION] Select Flight Lane</p>
            <div style="display: flex; gap: 10px; align-items: center;">
                <select id="route-type" onchange="toggleBaseInput()" style="flex-grow: 1; padding: 8px;">
                    <option value="binary">GIMPS Track (2^n)</option>
                    <option value="multi">Universal Track (P^n)</option>
                </select>
                <input type="number" id="base-val" placeholder="Base P" value="3" style="width: 80px; display: none;">
            </div>
        </div>
        
        <div style="margin-bottom: 20px;">
            <p style="color:#888;">[MICROSCOPE] Target Specific Prime or Exponent</p>
            <input type="text" id="manual-p" placeholder="Enter Starting Point">
            <button onclick="action('teleport')" class="btn-teleport">JUMP (TELEPORT)</button>
            <button onclick="action('generate')" class="btn-ignite">CRAWL (SCOUT)</button>
        </div>

        <div id="seed-panel" style="display:none; background: #2b1a00; padding: 15px; border-radius: 8px; border: 1px solid #ff8c00; margin-top: 10px;">
            <p style="color:#ff8c00; margin-top:0;">‚ö†Ô∏è STALL DETECTED: Bifurcation Possible</p>
            <div id="seed-buttons" style="display: flex; flex-wrap: wrap; gap: 5px;"></div>
        </div>
    </div>

    <div id="results-display"></div>
    
    <div class="panel" id="prey-board-container">
        <h3>PREY BOARD (Leaderboard)</h3>
        <div id="prey-board-list">Loading records...</div>
    </div>
</div>
    <script>
        // --- CONFIGURATION ---
            // We know this works because you tested it in the browser!
            //const API_URL = "https://si-yo-abc-prime-generator-api.hf.space/generate";
            //si-yo-abc/prime-generator-api
            const API_URL = "https://si-yo-abc-prime-generator-api.hf.space"; 
            // We split the token so GitHub doesn't "see" it and kill it
            const partA = "hf_"; 
            const partB = "dIhTAgaiHTPBRDcQBHnBzQHbVfttaGkQdI"; // Paste everything AFTER hf_ here
    
            const TOKEN = partA + partB; 
        // ---------------------
    let currentLeader = "";

    function toggleBaseInput() {
        const isMulti = document.getElementById('route-type').value === 'multi';
        document.getElementById('base-val').style.display = isMulti ? 'block' : 'none';
    }

    async function action(type, forcedBase = null) {
        const p = document.getElementById('manual-p').value || currentLeader;
        const route = document.getElementById('route-type').value;
        const base = forcedBase || document.getElementById('base-val').value;
        const display = document.getElementById('results-display');
        const seedPanel = document.getElementById('seed-panel');
        
        seedPanel.style.display = "none"; // Reset panel
        display.innerHTML = `<h2 style="color: #ff8c00">Dragon is ${type === 'teleport' ? 'Teleporting' : 'Scouting'} in ${route.toUpperCase()} Lane (Base ${base})...</h2>`;

        try {
            // Updated endpoint to handle new parameters
            const endpoint = type === 'teleport' 
                ? `/teleport?p=${p}&route=${route}&base=${base}` 
                : `/generate?p=${p}`;

            const response = await fetch(`${API_URL}${endpoint}`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${TOKEN}` }
            });
            const data = await response.json();

            if (data.prime || data.leader) {
                const prime = data.prime || data.leader;
                currentLeader = prime;
                document.getElementById('manual-p').value = prime;
                
                // Show the standard result card...
                display.innerHTML = renderResultCard(data, type);
                updatePreyBoard();
            } else if (data.alpha_seed) {
                // If it stalls but returns an Alpha Seed, show the Bifurcation Panel
                showBifurcation(data);
            }
        } catch (err) {
            display.innerHTML = `<p style="color:red">Engine Stall: ${err.message}</p>`;
        }
    }

    function showBifurcation(data) {
        const seedPanel = document.getElementById('seed-panel');
        const seedButtons = document.getElementById('seed-buttons');
        seedPanel.style.display = "block";
        
        // Take all unique seeds from the split composite logic
        const seeds = data.all_seeds || [data.alpha_seed];
        seedButtons.innerHTML = seeds.map(s => `
            <button onclick="switchLaneAndJump(${s})" style="background:#ff8c00; color:black; border:none; padding:5px 10px; cursor:pointer; font-weight:bold;">
                FOLLOW SEED ${s}
            </button>
        `).join('');
    }

    function switchLaneAndJump(newBase) {
        document.getElementById('route-type').value = 'multi';
        document.getElementById('base-val').value = newBase;
        toggleBaseInput();
        action('teleport', newBase);
    }

    function renderResultCard(data, type) {
        return `
            <div class="prime-card">
                <h2 style="color: #00bcff">TARGET NEUTRALIZED (${data.type || '100% PURE'})</h2>
                <span class="value" style="word-break: break-all;">${data.prime || data.leader}</span>
                <div class="stat-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
                    <div class="stat-item"><span class="stat-label">FIND TIME:</span> ${data.time || data.find_time}s</div>
                    <div class="stat-item"><span class="stat-label">BEACONS:</span> ${data.beacons_evaded || data.landings || 0}</div>
                    <div class="stat-item"><span class="stat-label">DNA:</span> ${data.structure || 'N/A'}</div>
                    <div class="stat-item"><span class="stat-label">ALPHA:</span> ${data.alpha_seed || 'None'}</div>
                </div>
            </div>`;
    }

    async function updatePreyBoard() {
        try {
            const res = await fetch(`${API_URL}/prey_board`, {
                headers: { 'Authorization': `Bearer ${TOKEN}` }
            });
            const data = await res.json();
            const list = document.getElementById('prey-board-list');
            list.innerHTML = data.map(r => `
                <div style="border-bottom:1px solid #333; padding:5px; font-size:0.9em;">
                    [${r.find}s] Prime: ${r.value.substring(0,20)}... | Beacons: ${r.beacons}
                </div>
            `).join('');
        } catch (e) { console.error("Prey Board Offline"); }
    } 

        // --- 1. Download Vault(solving the mystery) ---
        async function downloadVault() {
        
            try {
                const cleanUrl = API_URL.endsWith('/') ? API_URL.slice(0, -1) : API_URL;
                const res = await fetch(`${cleanUrl}/download_vault`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${TOKEN}` } // Same as your Purge!
                });
        
                if (!res.ok) {
                    alert("üõë Access Denied: Invalid Password or Token.");
                    return;
                }
        
                // Convert the response to a Blob (the file data)
                const blob = await res.blob();
                
                // Create a temporary link to trigger the download
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Dragon_Flight_Log_${new Date().getTime()}.csv`;
                document.body.appendChild(a);
                a.click();
                
                // Cleanup
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
        
            } catch (err) {
                console.error("Vault Error:", err);
                alert("Failed to reach the Vault.");
            }
        }
    
        // --- 2. THE PURGE (CLEAN SLATE) ---
        async function purgeVault() {
            const pw = prompt("Enter Dragon Command Password to Wipe Database:");
            if (!pw) return;
    
            try {
                // Added a safety check to make sure API_URL doesn't end in a slash
                const cleanUrl = API_URL.endsWith('/') ? API_URL.slice(0, -1) : API_URL;
                const res = await fetch(`${cleanUrl}/purge_memory?password=${pw}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                // If the response is HTML (404 page), this will throw the error we saw
                if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
                const data = await res.json();
                alert(data.status);
                currentLeader = "1";
                location.reload(); // Refresh to show the empty vault
            } catch (e) {
                alert("Purge Failed: Engine Offline.");
            }
        }
    
        async function huntNext() {
            document.getElementById('next-btn').style.display = "none";
            await ignite(currentLeader);
        }

        // Initialize board on load
    updatePreyBoard();
    </script>
</body>
</html>
