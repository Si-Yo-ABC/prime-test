<!DOCTYPE html>
<html>
<head>
    <title>Dragon Engine Test</title>
    <style>
        body { background: #0a0a0a; color: #00ff41; font-family: monospace; padding: 20px; }
        .prime-card { border: 1px solid #ff8c00; padding: 20px; border-radius: 10px; background: #111; }
        .value { color: white; word-break: break-all; font-size: 1.2em; }
    </style>
</head>
<body>
<div class="research-controls" style="background:#111; padding:20px; border: 1px solid #444; border-radius:10px;">
    <h3 style="color:#ff8c00; margin-top:0;">DRAGON CONTROL UNIT</h3>
    <input type="number" id="manual-p" placeholder="Enter Starting Prime" style="background:#000; color:#00ff41; border:1px solid #00ff41; padding:10px;">
    <button onclick="ignite(document.getElementById('manual-p').value)" style="background:#00ff41; color:#000; padding:10px 20px; border:none; cursor:pointer; font-weight:bold;">IGNITE ENGINE</button>
    
    <button onclick="purgeVault()" style="background:#440000; color:#ff0000; border:1px solid #ff0000; padding:10px; float:right; cursor:pointer;">PURGE ALL DATA</button>
</div>    
<button id="next-btn" onclick="huntNext()" style="display:none; background:#00bcff; color:#000; padding:10px; border:none; margin-bottom:10px; font-weight:bold; cursor:pointer;">HUNT NEXT PRIME</button>
<button onclick="downloadVault()" style="background:#440000; color:#ffaa55; border:1px solid #ff0000; padding:10px; float:right; cursor:pointer;">GET ALL DATA</button>
<div id="leaderboard"></div>

    <script>
        // --- CONFIGURATION ---
            // We know this works because you tested it in the browser!
            //const API_URL = "https://si-yo-abc-prime-generator-api.hf.space/generate";
            //si-yo-abc/prime-generator-api
            const API_URL = "https://si-yo-abc-prime-generator-api.hf.space"; 
            // We split the token so GitHub doesn't "see" it and kill it
            const partA = "hf_"; 
            const partB = "dIhTAgaiHTPBRDcQBHnBzQHbVfttaGkQdI"; // Paste everything AFTER hf_ here
    
            const TOKEN = partA + partB; 
        // ---------------------
    
        let currentLeader = "1"; 

        // --- 1. Download Vault(solving the mystery) ---
        async function downloadVault() {
        
            try {
                const cleanUrl = API_URL.endsWith('/') ? API_URL.slice(0, -1) : API_URL;
                const res = await fetch(`${cleanUrl}/download_vault`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${TOKEN}` } // Same as your Purge!
                });
        
                if (!res.ok) {
                    alert("ðŸ›‘ Access Denied: Invalid Password or Token.");
                    return;
                }
        
                // Convert the response to a Blob (the file data)
                const blob = await res.blob();
                
                // Create a temporary link to trigger the download
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Dragon_Flight_Log_${new Date().getTime()}.csv`;
                document.body.appendChild(a);
                a.click();
                
                // Cleanup
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
        
            } catch (err) {
                console.error("Vault Error:", err);
                alert("Failed to reach the Vault.");
            }
        }
    
        // --- 2. THE PURGE (CLEAN SLATE) ---
        async function purgeVault() {
            const pw = prompt("Enter Dragon Command Password to Wipe Database:");
            if (!pw) return;
    
            try {
                // Added a safety check to make sure API_URL doesn't end in a slash
                const cleanUrl = API_URL.endsWith('/') ? API_URL.slice(0, -1) : API_URL;
                const res = await fetch(`${cleanUrl}/purge_memory?password=${pw}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                // If the response is HTML (404 page), this will throw the error we saw
                if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
                const data = await res.json();
                alert(data.status);
                currentLeader = "1";
                location.reload(); // Refresh to show the empty vault
            } catch (e) {
                alert("Purge Failed: Engine Offline.");
            }
        }
    
        // --- 3. THE IGNITION (GENERATE) ---
        async function ignite(p) {
            if (!p) p = currentLeader;
            const display = document.getElementById('leaderboard');
            display.innerHTML = `<h2 style="color: #ff8c00">Dragon is hunting from ${p}...</h2>`;
    
            try {
                const response = await fetch(`${API_URL}/generate?p=${p}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                const data = await response.json();
    
                if (data.leader) {
                    currentLeader = data.leader;
                    const note = data.note === "Vault Hit" ? " (VAULT HIT)" : "";
                    
                    display.innerHTML = `
                        <div class="prime-card" style="border-color: #00ff41">
                            <h2 style="color: #00ff41">100% PURE PRIME FOUND${note}</h2>
                            <p><strong>LEADER:</strong> <span class="value">${data.leader}</span></p>
                            <hr>
                            <p><strong>LANDING GEAR SHIFTS:</strong> ${data.landings || 0}</p>
                            <p><strong>HUNT TIME:</strong> ${data.time}s</p>
                        </div>`;
                    
                    document.getElementById('next-btn').style.display = "inline-block";
                    document.getElementById('manual-p').value = data.leader;
                }
            } catch (err) {
                display.innerHTML = `<p style="color:red">Engine Stall: ${err.message}</p>`;
            }
        }
    
        async function huntNext() {
            document.getElementById('next-btn').style.display = "none";
            await ignite(currentLeader);
        }
    </script>
</body>
</html>
